# pythonæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

## ğŸ§ è®¾è®¡æ€è·¯

- python3 + pytest + parametrize + requests / httpx + yaml / excel ...

## ğŸ‘€ç›®å½•ç»“æ„ä»‹ç»

- common/: å…¬å…±ç±»
- core/: é…ç½®
- data/: æµ‹è¯•æ•°æ®
- db/: æ•°æ®åº“ç›¸å…³
- log/: æ—¥å¿—æ–‡ä»¶
- report/: æµ‹è¯•æŠ¥å‘Šå­˜æ”¾
- test_case/: æ”¾ç½®æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•é¡¹ç›®å’Œç”¨ä¾‹
- utils/: å·¥å…·åŒ…
- conftest.py: pytest.fixture é…ç½®
- pytest.ini pytest å‚æ•°é…ç½®
- run.py: pytest ä¸»ç¨‹åºè¿è¡Œå…¥å£

## ğŸ‘¨â€ğŸ’»ğŸ‘©â€ğŸ’»ä½¿ç”¨

å…‹éš†:

```shell
git clone https://gitee.com/wu_cl/automated_api_pytest.git
```

å®‰è£…ä¾èµ–åŒ…:

```shell
pip install -r requirements.txt
```

## æŒ‡å®šæµ‹è¯•é¡¹ç›®

å¤šé¡¹ç›®æ•°æ®ä¾æ®ç›®å½•å±‚çº§è¿›è¡Œéš”ç¦»

test_case ç›®å½•ä¸‹çš„ä¸€çº§æ–‡ä»¶å¤¹è§†ä¸ºå•ä¸ªé¡¹ç›®ç›®å½•

åœ¨ config.toml é…ç½®ä¸­ä¿®æ”¹ project = xxx ä¸ºå¯¹åº”çš„é¡¹ç›®ç›®å½•å

## æµ‹è¯•ç”¨ä¾‹æ•°æ®è¯´æ˜

### ç»“æ„å±•ç¤º

yaml æ•°æ®ï¼š

```yaml
config:
  allure:
    epic:
    feature:
    story:
  request:
    env:
    headers:
    timeout:
    verify:
    redirects:
    proxies:
      requests:
        http:
        https:
  #        httpx:
  #          http://:
  #          https://:
  module:

test_steps:
  - name:
    case_id:
    description:
    is_run:
    request:
      method:
      url:
      params:
      headers:
      data_type:
      data:
      files:
        xxx:
    setup:
      sql:
        - key:
          set_type:
          sql:
          jsonpath:
        - select * from xxx where xxx=xxx
      hooks:
        - func:
      wait_time:
    teardown:
      sql:
      hooks:
      extract:
        - key:
          set_type:
          jsonpath:
      assert:
        - check:
          value:
          type:
          jsonpath:
        - assert 200 = pm.response.get('status_code')
      wait_time:
```

~~excel æ•°æ®ï¼š~~

```text
release ç‰ˆæœ¬å·²ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºå—é™äºæ•°æ® json ç»“æ„ï¼Œå¯¹äº excel æ¥è¯´ï¼Œç¼–å†™åŠä¿®æ”¹éƒ½ç•¥æ˜¾ç¹çï¼Œ
å°½ç®¡æ•°æ®è§£ææ—¶è€ƒè™‘äº† excel æ•°æ®çš„æƒ…å†µï¼Œä½†è¿™ç§æ–¹å¼å·²ç»è¢«æå‰æ‹¦æˆª
```

### å‚æ•°è¯´æ˜ï¼š

| å‚æ•°            |                ç±»å‹                 | å¿…å¡«  | è¯´æ˜                                                               |
|:--------------|:---------------------------------:|-----|:-----------------------------------------------------------------|
| config        |               dict                | Y   | æµ‹è¯•ç”¨ä¾‹é…ç½®                                                           |
| + allure      |               dict                | Y   | allure æµ‹è¯•æŠ¥å‘Šé…ç½®                                                    |
| ++ epic       |                str                | Y   | allure epic                                                      |
| ++ feature    |                str                | Y   | allure feature                                                   |
| ++ story      |                str                | Y   | allure story                                                     |
| + request     |               dict                | Y   | è¯·æ±‚å‚æ•°                                                             |
| ++ env        |                str                | Y   | æµ‹è¯•ç¯å¢ƒ                                                             |
| ++ headers    |            dict / null            | N   | è¯·æ±‚å¤´                                                              |
| ++ timeout    |            int / null             | N   | è¯·è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œåˆ™åº”ç”¨æœ¬æ•°æ®æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œ<br/> å¦‚æœä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ™é»˜è®¤åº”ç”¨ conf é…ç½®æ–‡ä»¶       |
| ++ verify     |            bool / null            | N   | è¯·æ±‚éªŒè¯ï¼Œåº”ç”¨åŒä¸Š                                                        |
| ++ redirects  |            bool / null            | N   | é‡å®šå‘ï¼Œåº”ç”¨åŒä¸Š                                                         |
| ++ proxies    |            dict / null            | N   | ä»£ç†ï¼Œåº”ç”¨åŒä¸Š                                                          |
| +++ requests  |               dict                | N   | requests å¼•æ“ä»£ç†ï¼Œä»…å½“ä½¿ç”¨ requests å‘é€è¯·æ±‚æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨                           |
| ++++ http     |            str / null             | / Y | http ä»£ç†                                                          |
| ++++ https    |            str / null             | / Y | https ä»£ç†                                                         |
| +++ httpx     |               dict                | N   | httpx å¼•æ“ä»£ç†ï¼Œä»…å½“ä½¿ç”¨ httpx å‘é€è¯·æ±‚æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨                                 |
| ++++ http://  |            str / null             | / Y | http ä»£ç†                                                          |
| ++++ https:// |            str / null             | / Y | https ä»£ç†                                                         |
| + module      |                str                | Y   | ç”¨ä¾‹æ‰€å±æ¨¡å—                                                           |
| test_steps    |            list / dict            | Y   | æµ‹è¯•æ­¥éª¤ï¼Œå¤šç”¨ä¾‹æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ list æ ¼å¼                                           |
| + name        |                str                | Y   | ç”¨ä¾‹åç§°                                                             |
| + case_id     |                str                | Y   | ç”¨ä¾‹ id                                                            |
| + description |                str                | Y   | ç”¨ä¾‹æè¿°                                                             |
| + is_run      |            bool / null            | Y   | æ˜¯å¦è·³è¿‡                                                             |
| + request     |               dict                | Y   | è¯·æ±‚å‚æ•°                                                             |
| ++ method     |                str                | Y   | è¯·æ±‚æ–¹å¼                                                             |
| ++ url        |                str                | Y   | è¯·æ±‚é“¾æ¥ï¼Œä¸åŒ…å«åŸŸåï¼ŒåŸŸååœ¨æµ‹è¯•ç¯å¢ƒä¸­ä»¥ host=xxx é…ç½®                                 |
| ++ params     |        dict / bytes / null        | Y   | è¯·æ±‚æŸ¥è¯¢å‚æ•°                                                           |
| ++ headers    |            dict / null            | Y   | è¯·æ±‚å¤´ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä¼šåº”ç”¨ä¸Šæ–¹é…ç½®ä¸­çš„è¯·æ±‚å¤´                                           |
| ++ data_type  |            str / null             | Y   | è¯·æ±‚æ•°æ®ç±»å‹: data / json                                              |
| ++ data       | dict / bytes / Tuple(list) / null | Y   | è¯·æ±‚ä½“                                                              |
| ++ files      |   List\[Dict\[list/str]] / null   | Y   | è¯·æ±‚æ–‡ä»¶                                                             |
| + setup       |               dict                | N   | è¯·æ±‚å‰ç½®æ¡ä»¶                                                           |
| ++ sql        |    List\[ dict / str ] / null     | N   | è¯·æ±‚å‰ç½® sqlï¼Œå½“ä¸ºæ‰§è¡Œ sql æ—¶ï¼Œæ ¼å¼ä¸º List\[str]ï¼Œ<br/> å½“ä¸ºè®¾ç½®å˜é‡æ—¶ï¼Œæ ¼å¼ä¸º List\[dict] |                                                              |
| ++ hooks      |         List\[str] / null         | N   | é’©å­å‡½æ•°                                                             |
| ++ wait_time  |            int / null             | N   | è¯·æ±‚å‰ç­‰å¾…æ—¶é—´                                                          |
| + teardown    |               dict                | N   | è¯·æ±‚åç½®æ¡ä»¶                                                           |
| ++ sql        |    List\[ dict / str ] / null     | N   | åŒå‰ç½®                                                              |
| ++ hooks      |         List\[str] / null         | N   | åŒå‰ç½®                                                              |
| ++ extract    |            List\[dict]            | N   | å˜é‡æå–                                                             |
| +++ key       |                str                | / Y | å˜é‡ key                                                           |
| +++ set_type  |                str                | / Y | å˜é‡ç±»å‹: env / global / cacheï¼Œé»˜è®¤ cache                              |
| +++ jsonpath  |               dict                | / Y | jsonpath è¡¨è¾¾å¼ï¼Œä¾èµ– response æ•°æ®é›†                                     |
| ++ assert     |        List\[ dict / str ]        | N   | æ–­è¨€                                                               |                                                        |
| ++ wait_time  |            int / null             | N   | è¯·æ±‚åç­‰å¾…æ—¶é—´                                                          |

> **sql å‚æ•°é™„åŠ è¯´æ˜ï¼š**

set_up / tear_down çš„ sql å‚æ•°æ”¯æŒä¸¤ç§åŠŸèƒ½ï¼š

1. è®¾ç½®å˜é‡
2. æ‰§è¡Œ sql è¯­å¥

è®¾ç½®å˜é‡æ ¼å¼ï¼š

```yaml
sql:
  - key: å˜é‡ key / str
    set_type: å˜é‡ç±»å‹ï¼šenv / global / cacheï¼Œé»˜è®¤ cache
    sql: æ‰§è¡Œ sql æŸ¥è¯¢
    jsonpath: jsonpath è¡¨è¾¾å¼ï¼Œæ•°æ®ä¾èµ– sql æŸ¥è¯¢
```

> **assert å‚æ•°é™„åŠ è¯´æ˜ï¼š**

æ–­è¨€æ”¯æŒå¤šç§æ ¼å¼ï¼Œè¯¦ç»†è¯´æ˜è¯·æ‰“å¼€ assert_control.py æ–‡ä»¶ï¼Œä»¥ reStructuredText æ–¹å¼æŸ¥é˜…ï¼Œ
ä»¥ä¸‹ä¸¤ç‚¹åšæ¦‚è¦è¯´æ˜ï¼š

1. å¸¸è§„æ–­è¨€ï¼šåƒæ­£å¸¸ assert çš„æ ¼å¼ï¼Œä½†æ˜¯æ¯”è¾ƒå€¼å—çº¦æŸï¼Œä» response æ•°æ®é›†è¿›è¡Œå–å€¼ï¼Œ
   å¹¶ä¸”ä»¥ pm.response.get('') å¼€å§‹å–å€¼ï¼Œåé¢å¯ä»¥ç»§ç»­ get()ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼Œåªè¦
   æ˜¯ python å¯æ‰§è¡Œä»£ç ï¼Œå¹¶ä¸”ä¸ºäº†é¿å…å¼•å·é—®é¢˜ï¼Œæ–­è¨€è„šæœ¬å¿…é¡»ä½¿ç”¨å•å¼•å·å¤„ç†

2. jsonpathï¼šä½¿ç”¨ jsonpath ä» response è¿›è¡Œå–å€¼æ¯”è¾ƒ
3. ä¸¤ç§æ–­è¨€æ–¹å¼å¯ä»¥åŒæ—¶ä½¿ç”¨

å¸¸è§„æ–­è¨€æ ¼å¼ä¸¾ä¾‹ï¼š

```yaml
assert:
  - assert xxx æ¡ä»¶ pm.response.get('')..., 'é”™è¯¯è¯´æ˜'
```

jsonpath æ ¼å¼ä¸¾ä¾‹ï¼š

```yaml
assert:
  - check: æ£€æŸ¥è¯´æ˜ / str
    value: æ¯”è¾ƒå€¼ / Any
    type: æ¯”è¾ƒç±»å‹ï¼Œè¯·æŸ¥é˜… assert_type.py æ–‡ä»¶
    jsonpath: jsonpath è¡¨è¾¾å¼
```

### å˜é‡åŠhooksçš„ä½¿ç”¨

å…¨å±€å˜é‡å®šä¹‰ï¼š

```text
ä»…åœ¨ data ç›®å½•ä¸‹çš„ global_vars.yml ä¸­ä»¥é”®å€¼å¯¹å½¢å¼è¿›è¡Œå®šä¹‰ï¼Œå¯å‚è€ƒdemo
```

ç¯å¢ƒå˜é‡å®šä¹‰ï¼š

```text
åœ¨æµ‹è¯•ç”¨ä¾‹ä¾èµ–çš„ç¯å¢ƒæ–‡ä»¶ä¸­ä»¥é”®=å€¼çš„å½¢å¼è¿›è¡Œå®šä¹‰
```

hooks å‡½æ•°å®šä¹‰:

```text
ä»…åœ¨ data ç›®å½•ä¸‹çš„ hooks.py æ–‡ä»¶ä¸­å®šä¹‰ï¼Œæ ¹æ®å®šä¹‰ç»“æ„åœ¨ç”¨ä¾‹æ•°æ®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œå¯å‚è€ƒ demo    
```

**ä½¿ç”¨è¡¨è¾¾å¼:**

å˜é‡ï¼š

      ${var} æˆ– $var

hooksï¼šä»…åœ¨å‰åç½® hooks å‚æ•°ä¸‹é…ç½®æ—¶ç”Ÿæ•ˆ

      ${func()} æˆ– ${func($var1, $var2)}

çº¦æŸï¼š

      å˜é‡å’Œ hooks å¼€å¤´: a-zA-Z_

### ç”¨ä¾‹ä¸­çš„å˜é‡æ›¿æ¢

åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œå¯»æ‰¾å˜é‡é¡ºåºä¸ºï¼š cache > env > globalï¼Œæ‰¾åˆ°å˜é‡åå°†è‡ªåŠ¨æ›¿æ¢æ•°æ®ï¼Œæœªæ‰¾åˆ°å°†ä¼šæŠ›å‡ºå¼‚å¸¸

### å˜é‡è®¾ç½®è¯´æ˜

å˜é‡è®¾ç½®å«æœ‰ä¸‰ç§åœºæ™¯ï¼š

1. envï¼šå³åœ¨å½“å‰æµ‹è¯•ç”¨ä¾‹æ•°æ®æ‰€è°ƒç”¨çš„æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡ŒæŒä¹…åŒ–å†™å…¥ï¼Œé”®å€¼ä¸ä¼šé‡å¤ï¼Œæ–°å€¼è¦†ç›–æ—§å€¼
2. global: åœ¨å…¨å±€å˜é‡æ–‡ä»¶ä¸­è¿›è¡ŒæŒä¹…åŒ–å†™å…¥ï¼Œé”®å€¼ä¸ä¼šé‡å¤ï¼Œæ–°å€¼è¦†ç›–æ—§å€¼
3. cacheï¼šå†™å…¥å½“å‰ç”¨ä¾‹ç±»è¿è¡Œè¿‡ç¨‹çš„å†…å­˜ä¸­ï¼Œä¸ä¼šæŒä¹…åŒ–ï¼Œç±»è¿è¡Œç»“æŸæ¸…æ¥šè‡ªåŠ¨æ¸…é™¤

## ç”¨ä¾‹åˆ›å»º

1. æ ¹æ®æ•°æ®ç»“æ„åŠå‚æ•°è¯´æ˜ï¼Œæ‰‹åŠ¨ç¼–å†™æµ‹è¯•ç”¨ä¾‹
2. é€šè¿‡ cli è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹

cli ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹è¯´æ˜:

```shell
cd fastpt

python cli.py --gtc
```

## å¦‚ä½•è¿è¡Œæµ‹è¯•

è¿è¡Œ run.py æ–‡ä»¶å³å¯

main ç¨‹åºå‚æ•°æ ¹æ®æƒ…å†µè¿›è¡Œè‡ªå®šä¹‰

## å¦‚ä½•æŸ¥çœ‹æŠ¥å‘Š

è¿è¡Œå®Œä¹‹ååˆ° report æ–‡ä»¶å¤¹ä¸‹æŸ¥çœ‹

## â“é—®é¢˜ç›¸å…³

### 1: ä¸ºä»€ä¹ˆæ²¡æœ‰æƒ³è¦çš„æ—¥å¿—å†…å®¹

æ—¥å¿—å†…å®¹éœ€è¦æ‰‹åŠ¨å†™å…¥, è¯¦ç»†ç¤ºä¾‹demoä¸­å‡ ä¹éƒ½æœ‰ä½“ç°, è¯·è‡ªè¡ŒæŸ¥çœ‹

### 2: ä¸ºä»€ä¹ˆæ²¡æœ‰æµ‹è¯•æŠ¥å‘Š

htmlï¼š

    è‡ªåŠ¨ç”Ÿæˆï¼Œæ£€æŸ¥ run å‚æ•°æ˜¯å¦å¼€å¯ html æŠ¥å‘Šåˆ›å»º, é»˜è®¤å¼€å¯

~~excelï¼š~~

    å½“å‰ release ç‰ˆæœ¬å·²ä¸é€‚ç”¨ï¼Œæµ‹è¯•æŠ¥å‘Šè¦æ‰‹åŠ¨å†™å…¥, å¹¶ä¾èµ– excel æµ‹è¯•æ•°æ®

yamlï¼š

    æµ‹è¯•æŠ¥å‘Šè¦æ‰‹åŠ¨å†™å…¥, å¾ˆå°‘ç”¨åˆ°ï¼Œè°ƒç”¨æ–¹æ³•è¯·æŸ¥çœ‹ yaml_handler.py æ–‡ä»¶

allureï¼š

    è‡ªåŠ¨ç”Ÿæˆ, é»˜è®¤å¼€å¯å¹¶è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è®¿é—®, å‰æå·²æ­£ç¡®å®‰è£… allure ç¨‹åº
